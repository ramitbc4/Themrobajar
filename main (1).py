<FULL CODE OMITTED HERE FOR BREVITY>